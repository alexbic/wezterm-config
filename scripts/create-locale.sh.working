#!/bin/bash
# –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª–∏ —Å –ø–∞–∫–µ—Ç–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
SOURCE_FILE="$1"
TARGET_LANG="$2"
VERBOSE=""

for arg in "$@"; do
    case $arg in
        -v|--verbose) VERBOSE="true" ;;
    esac
done

if [ -z "$SOURCE_FILE" ] || [ -z "$TARGET_LANG" ]; then
    echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <source_file> <target_lang> [-v]"
    exit 1
fi

if [ ! -f "$SOURCE_FILE" ]; then
    echo "‚ùå –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $SOURCE_FILE"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è locale –∏ –Ω–∞–∑–≤–∞–Ω–∏–π
get_locale_for_language() {
    local lang_code="$1"
    case "$lang_code" in
        "en") echo "en_US.UTF-8" ;;
        "de") echo "de_DE.UTF-8" ;;
        "ru") echo "ru_RU.UTF-8" ;;
        "fr") echo "fr_FR.UTF-8" ;;
        *) 
            local lang_upper=$(echo "$lang_code" | tr '[:lower:]' '[:upper:]')
            echo "${lang_code}_${lang_upper}.UTF-8"
            ;;
    esac
}

get_language_name() {
    local lang_code="$1"
    case "$lang_code" in
        "en") echo "English" ;;
        "de") echo "German" ;;
        "ru") echo "–†—É—Å—Å–∫–∏–π" ;;
        "fr") echo "French" ;;
        *) echo "Unknown" ;;
    esac
}

SOURCE_DIR=$(dirname "$SOURCE_FILE")
NEW_FILE="$SOURCE_DIR/${TARGET_LANG}.lua"
TARGET_LOCALE=$(get_locale_for_language "$TARGET_LANG")
TARGET_NAME=$(get_language_name "$TARGET_LANG")

echo "üåê –°–æ–∑–¥–∞–Ω–∏–µ $TARGET_NAME –ª–æ–∫–∞–ª–∏"

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∏ –∑–∞–º–µ–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
cp "$SOURCE_FILE" "$NEW_FILE"
sed -i '' "s/ru_RU\.UTF-8/$TARGET_LOCALE/g" "$NEW_FILE"
sed -i '' "s/\"–†—É—Å—Å–∫–∏–π\"/\"$TARGET_NAME\"/g" "$NEW_FILE"
sed -i '' "s/-- –†—É—Å—Å–∫–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è.*/-- $TARGET_NAME localization/" "$NEW_FILE"

# –î–æ–±–∞–≤–ª—è–µ–º TODO –º–∞—Ä–∫–µ—Ä—ã
sed -i '' 's/ = "\([^"]*[–∞-—è—ë][^"]*\)"/ = "\1" -- TODO:translate/gi' "$NEW_FILE"

# –°–ë–û–† –î–ê–ù–ù–´–• –î–õ–Ø –ü–ê–ö–ï–¢–ù–û–ì–û –ü–ï–†–ï–í–û–î–ê
echo "üìä –°–±–æ—Ä –∫–ª—é—á–µ–π –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞..."
KEYS=()
RUSSIAN_TEXTS=()

while IFS= read -r line; do
    if echo "$line" | grep "TODO:translate" >/dev/null; then
        key_name=$(echo "$line" | sed 's/^[[:space:]]*\([^[:space:]]*\) = .*/\1/')
        russian_text=$(echo "$line" | sed 's/.*= "\(.*\)" -- TODO:translate/\1/')
        
        if [ -n "$russian_text" ] && [ "$russian_text" != "$line" ]; then
            KEYS+=("$key_name")
            RUSSIAN_TEXTS+=("$russian_text")
        fi
    fi
done < "$NEW_FILE"

TOTAL_KEYS=${#KEYS[@]}
echo "üéØ –ù–∞–π–¥–µ–Ω–æ –∫–ª—é—á–µ–π: $TOTAL_KEYS"

if [ $TOTAL_KEYS -eq 0 ]; then
    echo "‚úÖ –ù–µ—Ç –∫–ª—é—á–µ–π –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞"
    exit 0
fi

# –°–û–ó–î–ê–ï–ú –í–†–ï–ú–ï–ù–ù–´–ô –§–ê–ô–õ –î–õ–Ø –ü–ê–ö–ï–¢–ù–û–ì–û –ü–ï–†–ï–í–û–î–ê
BATCH_INPUT=$(mktemp)
BATCH_OUTPUT=$(mktemp)

echo "üìù –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞..."
for russian_text in "${RUSSIAN_TEXTS[@]}"; do
    echo "$russian_text" >> "$BATCH_INPUT"
done

echo "üöÄ –ü–ê–ö–ï–¢–ù–´–ô –ü–ï–†–ï–í–û–î (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫)..."
echo "‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º $TOTAL_KEYS —Å—Ç—Ä–æ–∫ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥..."

# –í–´–ü–û–õ–ù–Ø–ï–ú –ü–ê–ö–ï–¢–ù–´–ô –ü–ï–†–ï–í–û–î
if gtimeout 120 trans -brief "ru:${TARGET_LANG}" -i "$BATCH_INPUT" > "$BATCH_OUTPUT" 2>/dev/null; then
    echo "‚úÖ –ü–∞–∫–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    
    # –ß–ò–¢–ê–ï–ú –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–ï–†–ï–í–û–î–ê
    TRANSLATIONS=()
    while IFS= read -r line; do
        # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        clean_line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/,$//')
        TRANSLATIONS+=("$clean_line")
    done < "$BATCH_OUTPUT"
    
    # –ü–†–ò–ú–ï–ù–Ø–ï–ú –ü–ï–†–ï–í–û–î–´ –ö –§–ê–ô–õ–£
    echo "üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∫ —Ñ–∞–π–ª—É..."
    cp "$NEW_FILE" "${NEW_FILE}.backup"
    
    for i in "${!KEYS[@]}"; do
        if [ $i -lt ${#TRANSLATIONS[@]} ]; then
            russian_text="${RUSSIAN_TEXTS[$i]}"
            translated_text="${TRANSLATIONS[$i]}"
            
            if [ -n "$translated_text" ] && [ "$translated_text" != "$russian_text" ]; then
                # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥
                perl -CSD -i -pe "s/\Q\"$russian_text\" -- TODO:translate\E/\"$translated_text\" -- Auto-translated/g" "$NEW_FILE"
            fi
        fi
    done
    
    # –í–´–í–û–î–ò–ú –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ê–ë–õ–ò–¶–ï–ô
    if [ "$VERBOSE" ]; then
        echo ""
        echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞:"
        echo ""
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–ª–æ–Ω–æ–∫
        MAX_KEY_LEN=0
        MAX_RU_LEN=0
        
        for i in "${!KEYS[@]}"; do
            key_len=${#KEYS[$i]}
            ru_len=${#RUSSIAN_TEXTS[$i]}
            
            [ $key_len -gt $MAX_KEY_LEN ] && MAX_KEY_LEN=$key_len
            [ $ru_len -gt $MAX_RU_LEN ] && MAX_RU_LEN=$ru_len
        done
        
        MAX_KEY_LEN=$((MAX_KEY_LEN + 1))
        
        # –í—ã–≤–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü—É
        TRANSLATED_COUNT=0
        for i in "${!KEYS[@]}"; do
            if [ $i -lt ${#TRANSLATIONS[@]} ]; then
                translation="${TRANSLATIONS[$i]}"
                if [ -n "$translation" ] && [ "$translation" != "${RUSSIAN_TEXTS[$i]}" ]; then
                    printf "‚úÖ %-${MAX_KEY_LEN}s %-${MAX_RU_LEN}s ‚Üí %s\n" \
                        "${KEYS[$i]}:" \
                        "${RUSSIAN_TEXTS[$i]}" \
                        "$translation"
                    TRANSLATED_COUNT=$((TRANSLATED_COUNT + 1))
                else
                    printf "‚ùå %-${MAX_KEY_LEN}s %-${MAX_RU_LEN}s ‚Üí %s\n" \
                        "${KEYS[$i]}:" \
                        "${RUSSIAN_TEXTS[$i]}" \
                        "(–Ω–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ)"
                fi
            fi
        done
        
        echo ""
        echo "üìä –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: $TRANSLATED_COUNT/$TOTAL_KEYS"
    fi
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞!"
    TRANSLATED_COUNT=0
fi

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
rm -f "$BATCH_INPUT" "$BATCH_OUTPUT"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
if luac -p "$NEW_FILE" 2>/dev/null; then
    rm -f "${NEW_FILE}.backup"
    echo ""
    echo "‚úÖ $TARGET_NAME –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: $NEW_FILE"
    [ -z "$VERBOSE" ] && echo "üìä –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: ${TRANSLATED_COUNT:-0}/$TOTAL_KEYS"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞!"
    mv "${NEW_FILE}.backup" "$NEW_FILE"
    exit 1
fi

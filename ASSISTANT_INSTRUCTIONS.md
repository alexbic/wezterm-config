# 🤖 ИНСТРУКЦИИ ДЛЯ AI АССИСТЕНТА - WEZTERM CONFIG PROJECT

## 👤 КОНТЕКСТ ОПЕРАТОРА
- **Имя оператора:** Александр
- **Язык общения:** Русский
- **Платформа:** macOS
- **Уровень экспертизы:** Средний (WezTerm)

## ⚙️ НАСТРОЙКИ ДИАЛОГА
- **Тип ассистента:** Claude
- **Реальный лимит:** ~35 сообщений (НЕ 100!)
- **Порог подготовки к завершению:** 28+ сообщений (~80%)
- **Формат commit:** Подробный

## 📊 АВТОМАТИЧЕСКИЙ КОНТРОЛЬ ДИАЛОГА
**ОБЯЗАТЕЛЬНО:**
- Вести счетчик: #X/35 с первого сообщения
- При 15 сообщениях: первое предупреждение (45%)
- При 28 сообщениях: подготовка к завершению (80%)
- Обращаться по имени: "Александр"
- Адаптировать под средний уровень WezTerm
- Команды для macOS

## 🚨 КРИТИЧЕСКИЕ ПРАВИЛА (ПРИОРИТЕТ #1)

### 🛡️ ЗОЛОТОЕ ПРАВИЛО ВЫДАЧИ КОМАНД
- ВСЕГДА выдавать по ОДНОЙ команде
- ЖДАТЬ результата от пользователя
- АНАЛИЗИРОВАТЬ результат перед следующей
- НЕ выдавать блоки без ожидания
- НЕ переходить к следующему этапу без подтверждения

### ⚡ ГРУППИРОВКА КОМАНД С КОММЕНТАРИЯМИ
Обязательный паттерн:
echo "=== ОПИСАНИЕ ===" && команда1 && echo "этап" && команда2 && echo "SUCCESS"

### 🔍 ДИАГНОСТИКА ПЕРЕД ДЕЙСТВИЕМ
ВСЕГДА перед sed/исправлениями:
- RESULT=$(grep -n "проблема" файл) && echo "$RESULT"
- Анализировать контекст и причину
- Только потом предлагать исправления

### ⚙️ СИСТЕМЫ ЛОКАЛИЗАЦИИ WezTerm
КРИТИЧНЫЕ ПРАВИЛА:
- environment.locale.t.key - статическая таблица данных
- ЗАПРЕЩЕНО: environment.locale.t("key") или environment.locale.t(key)
- При ошибках "attempt to call a table value" - ищи старые вызовы функций
- Проверка: RESULT=$(grep -r "environment\.locale\.t(" .) && echo "$RESULT"

### 🎯 НОВОЕ ПРАВИЛО: ЧИСТЫЕ ЛОКАЛИ (КРИТИЧНО)
ПРИНЦИП: Файлы локалей = ТОЛЬКО чистый текст, БЕЗ:
- ❌ Иконок (🌍, 📍, 🔧)
- ❌ Форматирования (%s внутри)
- ❌ ANSI цветов
- ❌ Специальных символов

ВСЕ ФОРМАТИРОВАНИЕ через wezterm.format:
- ✅ Иконки из config/environment/icons.lua
- ✅ Цвета из config/environment/colors.lua
- ✅ %s подстановки в коде
- ✅ Структура через utils/environment.lua

### 🛡️ FALLBACK СИСТЕМА ДЛЯ UI
ВСЕГДА в диалогах создавать fallback функции:
- local FALLBACK_TEXTS = { key = "текст" }
- local function safe_get_text(key, ...) с проверкой на nil
- Экстренные команды восстановления в UI
- Защита от поломки локализации

## 🚨 РЕШЕНИЕ ПРОБЛЕМЫ cmdand dquote> (ПОЛНОЕ)

### ОБНАРУЖЕННЫЕ ПРИЧИНЫ
1. Сложные regex с экранированием в grep внутри && цепочек
2. Множественное экранирование в echo команды
3. Markdown блоки с тройными backticks в heredoc
4. Специальные символы в git commit сообщениях

### РАБОЧИЕ РЕШЕНИЯ
1. ИЗОЛЯЦИЯ GREP: RESULT=$(grep pattern file) && echo "$RESULT"
2. ПРОСТЫЕ ECHO: избегать сложного экранирования
3. HEREDOC БЕЗ MARKDOWN: не использовать тройные backticks внутри heredoc
4. ПРОСТЫЕ GIT COMMIT: без спецсимволов в многострочных сообщениях

### БЕЗОПАСНЫЕ ПАТТЕРНЫ
РАБОТАЕТ: RESULT=$(grep -rn "pattern" .)
РАБОТАЕТ: cat > file << 'EOF' простой текст EOF
РАБОТАЕТ: git add . && git commit -m "Простое описание"

### ОБНОВЛЕННОЕ ПРАВИЛО
- ВСЕГДА изолировать grep команды в переменные
- НИКОГДА не использовать сложное экранирование в echo
- ИЗБЕГАТЬ markdown форматирования в heredoc
- ИСПОЛЬЗОВАТЬ простые git commit сообщения

## 🚨 НОВЫЕ ПАТТЕРНЫ ОШИБОК WEZTERM (ИЗ ПРАКТИКИ)

### 🔴 АВТОПЕРЕВОД ПОРТИТ ФОРМАТИРОВАНИЕ
Проблема: Google Translate %s→%S, %d→%D
Решение: sed 's/%S/%s/g; s/%D/%d/g' после автоперевода
Проверка: grep -E "%[A-Z]" файл.lua

### 🔴 ЦИКЛИЧЕСКИЕ ЗАВИСИМОСТИ CONFIG
Проблема: config/ модули импортируют wezterm напрямую
Решение: config/=данные, utils/=функции, параметры передавать
Правило: config/ НЕ должен содержать require('wezterm')

### 🔴 ДУБЛИРОВАНИЕ КЛЮЧЕЙ ЛОКАЛИЗАЦИИ
Проблема: Копирование блоков с дублированными ключами
Диагностика: grep -o '^  [a-zA-Z_]*' file.lua | sort | uniq -d
Решение: sed удаление дублированного блока + luac -p проверка

### 🔴 КЭШ РАССИНХРОНИЗАЦИЯ
Проблема: Ключи в ru.lua, но НЕ в config/environment/locale.lua
Решение: env_utils.rebuild_locale_cache_file() после изменений
Проверка: grep "новый_ключ" config/environment/locale.lua

### 🔴 NIL В STRING.FORMAT
Проблема: string.format(text, nil) в UI диалогах
Решение: safe_get_text() функция с fallback
Паттерн: text = env.locale.t.key or FALLBACK_TEXTS[key] or key

## 🔧 ФИНАЛЬНЫЕ ПРИНЦИПЫ
- Простота превыше всего
- Одна команда - один результат
- Изоляция сложных операций
- Проверенные паттерны

## 📊 АЛГОРИТМ ЗАВЕРШЕНИЯ ЧАТОВ (28-35 сообщений)

### 1️⃣ АНАЛИЗ ПАТТЕРНОВ (28-30)
- Собрать новые найденные паттерны ошибок
- Выявить архитектурные принципы
- Документировать технические решения

### 2️⃣ ПЛАН СЛЕДУЮЩЕГО ЧАТА (30-32)
- Конкретные задачи с номерами сообщений
- Приоритеты и файлы для работы
- Ожидаемые результаты

### 3️⃣ COMMIT И GITHUB (33-35)
- Подготовка COMMIT_MESSAGE.md
- git add . && git commit -F COMMIT_MESSAGE.md
- Только критичные исправления

---
Создано для Александра - WezTerm локализация
Последнее обновление: 2025-06-05
ФИНАЛЬНАЯ ВЕРСИЯ с новыми паттернами и алгоритмом завершения

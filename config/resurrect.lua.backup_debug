-- cat > ~/.config/wezterm/config/resurrect.lua << 'EOF'
--
-- ÐžÐŸÐ˜Ð¡ÐÐÐ˜Ð•: ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑÑÐ¸Ð¹
-- Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ð²ÑÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° resurrect.wezterm: 
-- Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ, Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ, Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹, Ð¸ Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸.
-- Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·ÑƒÐµÑ‚ Ð²ÑÑŽ Ð»Ð¾Ð³Ð¸ÐºÑƒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑÑÐ¸Ð¹.
--
-- Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð˜: events.session-status

local wezterm = require('wezterm')
local session_status = require('events.session-status')
local environment = require('config.environment')
local M = {}

-- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° resurrect.wezterm
local resurrect = wezterm.plugin.require("https://github.com/MLFlexer/resurrect.wezterm")
M.resurrect = resurrect

-- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚
resurrect.state_manager.periodic_save({
  interval_seconds = 300,
  save_tabs = true,
  save_windows = true,
  save_workspaces = true,
})

-- ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ð° ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼Ñ‹Ñ… ÑÑ‚Ñ€Ð¾Ðº
resurrect.state_manager.set_max_nlines(5000)

-- ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
local is_periodic_save = false
local is_user_save = false
local current_save_name = ""
local current_operation = nil -- "load", "delete", "save"
local selected_session_name = nil
local list_shown_timer = nil
local pending_operation = nil -- Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰Ð¸Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
local save_timeout_timer = nil
local pending_restore = nil -- Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ

-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð²ÑÐµÑ… Ð²ÐºÐ»Ð°Ð´Ð¾Ðº
local function safe_clear_tabs(window)
  local mux_window = window:mux_window()
  local tabs = mux_window:tabs()
  
  wezterm.log_info("ðŸ”„ Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° - Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð²ÐºÐ»Ð°Ð´Ð¾Ðº: " .. #tabs)
  
  -- ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð²ÐºÐ»Ð°Ð´ÐºÑƒ, Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼
  for i = #tabs, 2, -1 do
    local tab = tabs[i]
    if tab then
      wezterm.log_info("ðŸ”„ Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÐºÐ»Ð°Ð´ÐºÑƒ " .. i)
      tab:activate()
      window:perform_action(wezterm.action.CloseCurrentTab({confirm = false}), tab:active_pane())
    end
  end
  
  wezterm.log_info("ðŸ”„ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°, Ð¾ÑÑ‚Ð°Ð»Ð°ÑÑŒ 1 Ð²ÐºÐ»Ð°Ð´ÐºÐ°")
end
-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
local function perform_restore(window, pane, id, session_name, type_info)
  wezterm.log_info("ðŸŽ¯ === ÐÐÐ§Ð˜ÐÐÐ•Ðœ Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ===")
  wezterm.log_info("ðŸŽ¯ Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ: " .. (session_name or "unknown"))
  wezterm.log_info("ðŸŽ¯ ID: " .. (id or "unknown"))
  wezterm.log_info("ðŸŽ¯ Ð¢Ð¸Ð¿: " .. (type_info or "unknown"))
  
  -- ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
  session_status.start_loading(window)
  
  -- Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰ÑƒÑŽ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑŽ
  pending_operation = {
    type = "load",
    window = window,
    session_name = session_name
  }
  
  local type = string.match(id, "^([^/]+)")
  local clean_id = string.match(id, "([^/]+)$")
  clean_id = string.match(clean_id, "(.+)%..+$")
  
  wezterm.log_info("ðŸŽ¯ ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿: " .. (type or "unknown"))
  wezterm.log_info("ðŸŽ¯ ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ ID: " .. (clean_id or "unknown"))
  
  -- ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð²ÐºÐ»Ð°Ð´ÐºÐ¸
  safe_clear_tabs(window) -- Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð²ÐºÐ»Ð°Ð´Ð¾Ðº
  
  -- Ð–Ð´ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ´ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼
  wezterm.time.call_after(1.0, function()
    wezterm.log_info("ðŸŽ¯ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ...")
    
    -- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ - ÐŸÐžÐ›ÐÐÐ¯ Ð·Ð°Ð¼ÐµÐ½Ð°
    local opts = {
      window = window:mux_window(),
      relative = false, -- Ð’ÐÐ–ÐÐž: ÐÐ• Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
      restore_text = true,
      on_pane_restore = resurrect.tab_state.default_on_pane_restore,
    }
    
    local success = false
    
    if type == "workspace" then
      wezterm.log_info("ðŸŽ¯ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ workspace: " .. clean_id)
      local state = resurrect.state_manager.load_state(clean_id, "workspace")
      if state then
        wezterm.log_info("ðŸŽ¯ Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ workspace Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾, Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼...")
        resurrect.workspace_state.restore_workspace(state, opts)
        success = true
      else
        wezterm.log_info("âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ workspace")
      end
    elseif type == "window" then
      wezterm.log_info("ðŸŽ¯ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ window: " .. clean_id)
      local state = resurrect.state_manager.load_state(clean_id, "window")
      if state then
        wezterm.log_info("ðŸŽ¯ Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ window Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾, Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼...")
        resurrect.window_state.restore_window(pane:window(), state, opts)
        success = true
      else
        wezterm.log_info("âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ window")
      end
    elseif type == "tab" then
      wezterm.log_info("ðŸŽ¯ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ tab: " .. clean_id)
      local state = resurrect.state_manager.load_state(clean_id, "tab")
      if state then
        wezterm.log_info("ðŸŽ¯ Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ tab Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾, Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼...")
        resurrect.tab_state.restore_tab(pane:tab(), state, opts)
        success = true
      else
        wezterm.log_info("âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ tab")
      end
    else
      wezterm.log_info("âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ: " .. (type or "nil"))
    end
    
    if not success then
      session_status.load_session_error(window, "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ")
      
      -- ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
      pending_operation = nil
      current_operation = nil
      selected_session_name = nil      pending_operation = nil
    else
      wezterm.log_info("ðŸŽ¯ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾")
    end
  end)
end

-- ========================== ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ˜ Ð¡ÐžÐ‘Ð«Ð¢Ð˜Ð™ ==========================

local function register_event_handlers()
  -- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
  wezterm.on('resurrect.error', function(error)
    wezterm.log_info("Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ resurrect.error: " .. tostring(error))
    
    local window = nil
    if wezterm.mux and wezterm.mux.get_active_window then
      window = wezterm.mux.get_active_window()
    end
    
    if window then
      if current_operation == "save" then
        session_status.save_session_error(window, tostring(error))
        current_operation = nil
        is_user_save = false
        current_save_name = ""
      else
        session_status.load_session_error(window, tostring(error))
      end
    end
  end)

  -- Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ„Ð»Ð°Ð³Ð° Ð¿Ñ€Ð¸ Ð½Ð°Ñ‡Ð°Ð»Ðµ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
  wezterm.on('resurrect.state_manager.periodic_save.start', function()
    is_periodic_save = true
    wezterm.log_info("ðŸŽ¯ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ")
  end)

  -- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
  wezterm.on('resurrect.state_manager.save_state.finished', function(session_path)
    wezterm.log_info("ðŸŽ¯ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ save_state.finished: " .. session_path .. " (periodic: " .. tostring(is_periodic_save) .. ", user: " .. tostring(is_user_save) .. ")")
    
    -- ÐžÑ‚Ð¼ÐµÐ½ÑÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð° ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ
    if save_timeout_timer then
      save_timeout_timer:cancel()
      save_timeout_timer = nil
    end
    
    if not is_periodic_save and is_user_save then
      local path = session_path:match(".+/([^/]+)$")
      local name = path and path:match("^(.+)%.json$") or current_save_name or "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"
      
      local window = nil
      if wezterm.mux and wezterm.mux.get_active_window then
        window = wezterm.mux.get_active_window()
      end
      
      if window then
        wezterm.log_info("ðŸŽ¯ Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ save_session_success Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼: " .. name)
        session_status.save_session_success(window, name)
        
        -- Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¾Ñ‚Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ - Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐµÐ³Ð¾
        if pending_restore then
          wezterm.log_info("ðŸŽ¯ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ")
          wezterm.time.call_after(2, function()
            perform_restore(pending_restore.window, pending_restore.pane, pending_restore.id, pending_restore.session_name, pending_restore.type_info)
            pending_restore = nil
          end)
        end
      end
      
      is_user_save = false
      current_save_name = ""
      current_operation = nil
    elseif is_periodic_save then
      is_periodic_save = false
      wezterm.log_info("ðŸŽ¯ ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾")
    end
  end)

  -- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
  wezterm.on('resurrect.state_manager.save_state.start', function(state, opt_name)
    wezterm.log_info("ðŸŽ¯ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ save_state.start Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼: " .. (opt_name or "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾") .. " (periodic: " .. tostring(is_periodic_save) .. ", user: " .. tostring(is_user_save) .. ")")
    
    if not is_periodic_save and is_user_save then
      wezterm.log_info("ðŸŽ¯ ÐÐ°Ñ‡Ð°Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ")
      current_operation = "save"
      
      -- Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð° Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ ÐµÑÐ»Ð¸ finished Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
      save_timeout_timer = wezterm.time.call_after(10, function()
        wezterm.log_info("ðŸŽ¯ Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ - Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÑÐ¿ÐµÑ…")
        local window = nil
        if wezterm.mux and wezterm.mux.get_active_window then
          window = wezterm.mux.get_active_window()
        end
        
        if window and is_user_save then
          session_status.save_session_success(window, current_save_name or "ÑÐµÑÑÐ¸Ñ")
          is_user_save = false
          current_save_name = ""
          current_operation = nil
          
          -- Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¾Ñ‚Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ - Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐµÐ³Ð¾
          if pending_restore then
            wezterm.log_info("ðŸŽ¯ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð°")
            wezterm.time.call_after(2, function()
              perform_restore(pending_restore.window, pending_restore.pane, pending_restore.id, pending_restore.session_name, pending_restore.type_info)
              pending_restore = nil
            end)
          end
        end
        save_timeout_timer = nil
      end)
    end
  end)

  -- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ (ÐºÐ¾Ð³Ð´Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð° ÑÐµÑÑÐ¸Ñ)
  wezterm.on('resurrect.state_manager.load_state.finished', function(name, type)
    wezterm.log_info("ðŸŽ¯ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ load_state.finished: " .. name .. ", Ñ‚Ð¸Ð¿: " .. type)
    
    -- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ Ð»Ð¸ ÑÑ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ
    if pending_operation and pending_operation.type == "load" then
      local window = pending_operation.window
      local session_name = pending_operation.session_name or name
      
      wezterm.log_info("ðŸŽ¯ ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰ÑƒÑŽ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: " .. session_name)
      session_status.load_session_success(window, session_name)
      
      -- ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
      pending_operation = nil
      current_operation = nil
      selected_session_name = nil      
      pending_operation = nil
      current_operation = nil
      selected_session_name = nil
    end
  end)

  -- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐµÑÑÐ¸Ð¸ (ÐºÐ¾Ð³Ð´Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð° ÑÐµÑÑÐ¸Ñ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ)
  wezterm.on('resurrect.state_manager.delete_state.finished', function(id)
    wezterm.log_info("ðŸŽ¯ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ delete_state.finished: " .. id)
    
    -- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ Ð»Ð¸ ÑÑ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ
    if pending_operation and pending_operation.type == "delete" then
      local window = pending_operation.window
      local session_name = pending_operation.session_name
      
      if not session_name then
        local path = id:match(".+/([^/]+)$")
        session_name = path and path:match("^(.+)%.json$") or id
      end
      
      wezterm.log_info("ðŸŽ¯ ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰ÑƒÑŽ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ: " .. session_name)
      session_status.delete_session_success(window, session_name)
      
      pending_operation = nil
      current_operation = nil
      selected_session_name = nil
    end
  end)

  -- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½Ð°Ñ‡Ð°Ð»Ð° fuzzy_load
  wezterm.on('resurrect.fuzzy_loader.fuzzy_load.start', function(window, pane)
    wezterm.log_info("Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ fuzzy_load.start")
  end)
  
  -- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ fuzzy_load
  wezterm.on('resurrect.fuzzy_loader.fuzzy_load.finished', function(window, pane)
    wezterm.log_info("Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ fuzzy_load.finished")
    
    -- ÐžÑ‚Ð¼ÐµÐ½ÑÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð¿Ð¾ÐºÐ°Ð·Ð° ÑÐ¿Ð¸ÑÐºÐ° ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ
    if list_shown_timer then
      list_shown_timer:cancel()
      list_shown_timer = nil
    end
    
    -- Ð•ÑÐ»Ð¸ Ð½Ð¸ÐºÐ¾Ð³Ð¾ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ - ÑÑ‚Ð¾ Ð¾Ñ‚Ð¼ÐµÐ½Ð°
    wezterm.time.call_after(0.3, function()
      if current_operation and not pending_operation then
        wezterm.log_info("ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¾Ñ‚Ð¼ÐµÐ½Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸: " .. current_operation)
        if current_operation == "load" then
          session_status.load_session_cancelled(window)
        elseif current_operation == "delete" then
          session_status.delete_session_cancelled(window)
        end
        current_operation = nil
        selected_session_name = nil
      end
    end)
  end)

  -- Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´ resurrect
  
  -- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
  wezterm.on('resurrect.save_state', function(window, pane)
    wezterm.log_info("ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ resurrect.save_state")
    
    window:perform_action(
      wezterm.action.PromptInputLine({
        description = "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÐµÑÑÐ¸Ð¸",
        action = wezterm.action_callback(function(inner_win, inner_pane, line)
          if line and line ~= "" then
            -- Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³Ð¸ Ð”Ðž Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
            is_user_save = true
            current_save_name = line
            current_operation = "save"
            
            wezterm.log_info("ðŸŽ¯ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼: " .. line)
            session_status.start_loading(window)
            
            -- ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ„Ð»Ð°Ð³Ð¸ Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ÑÑŒ
            wezterm.time.call_after(0.1, function()
              local state = resurrect.workspace_state.get_workspace_state()
              resurrect.state_manager.save_state(state, line)
            end)
          else
            -- Ð•ÑÐ»Ð¸ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾, Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ñ€ÐµÐ¶Ð¸Ð¼
            wezterm.log_info("ðŸŽ¯ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼")
            session_status.clear_saved_mode()
          end
        end),
      }),
      pane
    )
  end)

  -- Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
  wezterm.on('resurrect.restore_state', function(window, pane)
    wezterm.log_info("ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ resurrect.restore_state")
    
    local workspace_name = ""
    if wezterm.mux and wezterm.mux.get_active_workspace then
      workspace_name = wezterm.mux.get_active_workspace()
    end
    
    session_status.start_loading(window)
    
    local state = resurrect.state_manager.load_state(workspace_name, "workspace")
    if state then
      safe_clear_tabs(window) -- Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð²ÐºÐ»Ð°Ð´Ð¾Ðº
      wezterm.time.call_after(1.0, function()
        resurrect.workspace_state.restore_workspace(state, {
          window = window:mux_window(),
          relative = false, -- ÐÐ• Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ - Ð·Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ
          restore_text = true,
          on_pane_restore = resurrect.tab_state.default_on_pane_restore,
        })
      end)
    else
      session_status.load_session_error(window, "Ð¡ÐµÑÑÐ¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
    end
  end)

  -- Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
  wezterm.on('resurrect.load_state', function(window, pane)
    wezterm.log_info("ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ resurrect.load_state")
    
    current_operation = "load"
    selected_session_name = nil
    pending_operation = nil
    session_status.load_session_start(window)
    
    -- ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð³Ð´Ð° ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð¾ÑÐ²Ð¸Ð»ÑÑ
    list_shown_timer = wezterm.time.call_after(1, function()
      if current_operation == "load" then
        -- ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‡ÐµÑ€ÐµÐ· ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ resurrect
        local workspace_states = resurrect.state_manager.get_saved_states("workspace") or {}
        local window_states = resurrect.state_manager.get_saved_states("window") or {}
        local tab_states = resurrect.state_manager.get_saved_states("tab") or {}
        
        local total_count = 0
        for _ in pairs(workspace_states) do total_count = total_count + 1 end
        for _ in pairs(window_states) do total_count = total_count + 1 end
        for _ in pairs(tab_states) do total_count = total_count + 1 end
        
        wezterm.log_info("Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½, Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ " .. total_count .. " ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹")
        session_status.load_session_list_shown(window, total_count)
      end
      list_shown_timer = nil
    end)
    
    resurrect.fuzzy_loader.fuzzy_load(
      window, 
      pane, 
      function(id, label)
        wezterm.log_info("ðŸŽ¯ fuzzy_load callback Ð²Ñ‹Ð·Ð²Ð°Ð½ Ñ id: " .. id .. ", label: " .. (label or "no_label"))
        
        -- ÐžÐ¢Ð›ÐÐ”ÐšÐ: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
        wezterm.log_info("ðŸ” ÐžÐ¢Ð›ÐÐ”ÐšÐ: pending_operation = " .. tostring(pending_operation))
        wezterm.log_info("ðŸ” ÐžÐ¢Ð›ÐÐ”ÐšÐ: current_operation = " .. tostring(current_operation))
        wezterm.log_info("ðŸ” ÐžÐ¢Ð›ÐÐ”ÐšÐ: selected_session_name = " .. tostring(selected_session_name))        
        -- ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
        local type = string.match(id, "^([^/]+)")
        local type_display = "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"
        if type == "workspace" then
          type_display = "Ñ€Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ"
        elseif type == "window" then
          type_display = "Ð¾ÐºÐ½Ð¾"
        elseif type == "tab" then
          type_display = "Ð²ÐºÐ»Ð°Ð´ÐºÐ°"
        end
        
        -- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð¼Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸ Ð¸Ð· label Ð¸Ð»Ð¸ Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¸Ð· id
        if label and label ~= "" then
          selected_session_name = label
        else
          local clean_id = string.match(id, "([^/]+)$")
          selected_session_name = clean_id and string.match(clean_id, "(.+)%..+$") or clean_id
        end
        
        wezterm.log_info("ðŸŽ¯ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ Ð¸Ð¼Ñ ÑÐµÑÑÐ¸Ð¸ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: " .. (selected_session_name or "unknown"))
        
        -- Ð¡Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ - ÐÐÐ§Ð˜ÐÐÐ•Ðœ Ð¡ Ð’ÐžÐŸÐ ÐžÐ¡Ð
        local confirm_message = string.format(
          "Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸:\nðŸŽ¯ %s (%s)\n\nÐ¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹?\n(y/Ð´Ð° = ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ, Enter/Ð»ÑŽÐ±Ð°Ñ ÐºÐ»Ð°Ð²Ð¸ÑˆÐ° = Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ)\n",
          selected_session_name or "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾",
          type_display
        )
        
        window:perform_action(
          wezterm.action.PromptInputLine({
            description = confirm_message,
            action = wezterm.action_callback(function(inner_win, inner_pane, line)
              local response = (line or ""):lower()
              local should_save = response == "y" or response == "yes" or response == "Ð´Ð°" or response == "Ð´"
              
              wezterm.log_info("ðŸŽ¯ ÐžÑ‚Ð²ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ: '" .. (line or "") .. "', Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ: " .. tostring(should_save))
              
              if should_save then
                wezterm.log_info("ðŸŽ¯ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ")
                -- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾ÑÐ»Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
                pending_restore = {
                  window = window,
                  pane = pane,
                  id = id,
                  session_name = selected_session_name,
                  type_info = type_display
                }
                
                -- Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
                window:perform_action(
                  wezterm.action.PromptInputLine({
                    description = "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ",
                    action = wezterm.action_callback(function(save_win, save_pane, save_name)
                      if save_name and save_name ~= "" then
                        is_user_save = true
                        current_save_name = save_name
                        current_operation = "save"
                        
                        session_status.start_loading(window)
                        
                        wezterm.time.call_after(0.1, function()
                          local state = resurrect.workspace_state.get_workspace_state()
                          resurrect.state_manager.save_state(state, save_name)
                        end)
                      else
                        -- Ð•ÑÐ»Ð¸ Ð½Ðµ Ð²Ð²ÐµÐ»Ð¸ Ð¸Ð¼Ñ - Ð¾Ñ‚Ð¼ÐµÐ½ÑÐµÐ¼ Ð²ÑÐµ
                        wezterm.log_info("ðŸŽ¯ Ð˜Ð¼Ñ Ð½Ðµ Ð²Ð²ÐµÐ´ÐµÐ½Ð¾, Ð¾Ñ‚Ð¼ÐµÐ½ÑÐµÐ¼ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑŽ")
                        pending_restore = nil
                        session_status.clear_saved_mode()
                      end
                    end),
                  }),
                  pane
                )
              else
                wezterm.log_info("ðŸŽ¯ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ñ…Ð¾Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ, Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ€Ð°Ð·Ñƒ")
                -- Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ€Ð°Ð·Ñƒ Ð±ÐµÐ· ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
                perform_restore(window, pane, id, selected_session_name, type_display)
              end
            end),
          }),
          pane
        )
      end,
      {
        title = "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐµÑÑÐ¸Ð¸",
        description = "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐµÑÑÐ¸ÑŽ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter = Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ, Esc = Ð¾Ñ‚Ð¼ÐµÐ½Ð°, / = Ñ„Ð¸Ð»ÑŒÑ‚Ñ€",
        fuzzy_description = "ÐŸÐ¾Ð¸ÑÐº ÑÐµÑÑÐ¸Ð¸ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: ",
        is_fuzzy = true,
      }
    )
  end)

  -- Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
  wezterm.on('resurrect.delete_state', function(window, pane)
    wezterm.log_info("ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ resurrect.delete_state")
    
    current_operation = "delete"
    selected_session_name = nil
    pending_operation = nil
    session_status.delete_session_start(window)
    
    -- ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð³Ð´Ð° ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð¾ÑÐ²Ð¸Ð»ÑÑ
    list_shown_timer = wezterm.time.call_after(1, function()
      if current_operation == "delete" then
        -- ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‡ÐµÑ€ÐµÐ· ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ resurrect
        local workspace_states = resurrect.state_manager.get_saved_states("workspace") or {}
        local window_states = resurrect.state_manager.get_saved_states("window") or {}
        local tab_states = resurrect.state_manager.get_saved_states("tab") or {}
        
        local total_count = 0
        for _ in pairs(workspace_states) do total_count = total_count + 1 end
        for _ in pairs(window_states) do total_count = total_count + 1 end
        for _ in pairs(tab_states) do total_count = total_count + 1 end
        
        wezterm.log_info("Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½, Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ " .. total_count .. " ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹")
        session_status.delete_session_list_shown(window, total_count)
      end
      list_shown_timer = nil
    end)
    
    resurrect.fuzzy_loader.fuzzy_load(
      window, 
      pane, 
      function(id)
        wezterm.log_info("ðŸŽ¯ fuzzy_load callback Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð·Ð²Ð°Ð½ Ñ id: " .. id)
        
        -- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð¼Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸
        local clean_id = string.match(id, "([^/]+)$")
        selected_session_name = clean_id and string.match(clean_id, "(.+)%..+$") or clean_id
        
        wezterm.log_info("ðŸŽ¯ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ Ð¸Ð¼Ñ ÑÐµÑÑÐ¸Ð¸ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ: " .. (selected_session_name or "unknown"))
        
        -- Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰ÑƒÑŽ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑŽ
        pending_operation = {
          type = "delete",
          window = window,
          session_name = selected_session_name
        }
        
        wezterm.log_info("ðŸŽ¯ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ: " .. id)
        resurrect.state_manager.delete_state(id)
      end,
      {
        title = "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑÑÐ¸Ð¸",
        description = "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐµÑÑÐ¸ÑŽ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter = ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ, Esc = Ð¾Ñ‚Ð¼ÐµÐ½Ð°, / = Ñ„Ð¸Ð»ÑŒÑ‚Ñ€",
        fuzzy_description = "ÐŸÐ¾Ð¸ÑÐº ÑÐµÑÑÐ¸Ð¸ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ: ",
        is_fuzzy = true,
      }
    )
  end)

  -- Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ
  wezterm.on('resurrect.test_notification', function(window, pane)
    wezterm.log_info("Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ")
    
    if window then
      session_status.start_loading(window)
      
      wezterm.time.call_after(3, function()
        session_status.save_session_success(window, "Ñ‚ÐµÑÑ‚Ð¾Ð²Ð°Ñ_ÑÐµÑÑÐ¸Ñ")
      end)
    end
  end)
end

-- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
register_event_handlers()

return M
